<!DOCTYPE html>
<html lang="en">

<head>
  <title>Volunteer Task Dashboard</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700|Merriweather&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .wrapper {
      width: 95%;
      /*max-width: 1000px;*/
      margin: 0 auto;
    }

    header {
      background: #05124e;
      color: #ebebd3;
      position: relative;
      padding: 1em 0;
    }

    header::after {
      content: "";
      clear: both;
      display: block;
    }

    .logo {
      float: left;
      font-size: 1rem;
      margin: 0;
      text-transform: uppercase;
      font-weight: 700;
    }

    .logo span {
      font-weight: 400;
    }

    .main-nav {
      position: absolute;
      top: 100%;
      right: 0;
      left: 0;
      background: #464655;
      height: 0;
      overflow: hidden;
      transition: height 0.5s ease-in-out;
    }

    .main-nav-open {
      height: auto;
    }

    .main-nav ul {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .main-nav li {
      border-bottom: 1px solid #575766;
    }

    .main-nav li:last-child {
      border-bottom: none;
    }

    .main-nav a {
      color: white;
      display: block;
      padding: 1em 1em;
      text-decoration: none;
      text-transform: uppercase;
    }

    .main-nav a:hover,
    .main-nav a:focus {
      background: #e4b363;
      color: #464655;
    }

    .nav-icon {
      display: inline-block;
      font-size: 1.3em;
      margin-right: .5em;
      text-align: center;
      width: 1.1em;
      color: rgba(255, 255, 255, 0.45);
    }

    .menu-toggle {
      padding: 1em;
      position: absolute;
      top: 0.5em;
      right: 0.2em;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .hamburger,
    .hamburger::before,
    .hamburger::after {
      content: "";
      display: block;
      background: #ebebd3;
      height: 3px;
      width: 30px;
      transition: all ease-in-out 500ms;
    }

    .hamburger::before {
      transform: translateY(-6px);
    }

    .hamburger::after {
      transform: translateY(3px);
    }

    .open .hamburger {
      transform: rotate(45deg);
    }

    .open .hamburger::before {
      opacity: 0;
    }

    .open .hamburger::after {
      transform: rotate(90deg) translateY(3px);
    }

    @media only screen and (min-width: 700px) {
      .menu-toggle {
        display: none;
      }

      .main-nav {
        height: auto;
        position: relative;
        background: transparent;
        float: right;
      }

      .main-nav li {
        display: inline-block;
        border: none;
      }

      .main-nav a {
        padding: 0;
        margin-left: 2em;
      }

      .main-nav a:hover,
      .main-nav a:focus {
        background: transparent;
      }

      .nav-icon {
        display: none;
      }
    }

    body {
      font-family: 'Arial', sans-serif;
      background-image: url(./img/blue1.jpg);
      margin: 0;
      padding: 0;
    }

    .header {
      background: #002855;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      padding: 10px;
      background: #002855;
      color: white;
      margin-top: 20px;
    }

    .Disaster-Relief-Portal {
      background: #003366;
    }

    .header1 {
      background: #003366;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: #f8f9fa;
      color: #333;
    }

    .container-volunteer {
      max-width: 700px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .task-volunteer {
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
    }

    .task-volunteer.supply-task {
      cursor: pointer;
      background-color: #e3f2fd;
    }

    .status-btn-volunteer {
      background: #007bff;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .status-btn-volunteer:hover {
      background: #0056b3;
    }

    .header1 {
      background: #003366;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }

    .footer1 {
      background: #003366;
      color: white;
      text-align: center;
      padding: 15px;
      position: relative;
      bottom: 0;
      width: 100%;
    }

    /* Progress Graph Styles */
    .progress-graph {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      margin: 20px 0;
      padding: 10px 0;
    }

    .progress-graph::before {
      content: "";
      position: absolute;
      top: 15px;
      left: 15%;
      width: 70%;
      height: 4px;
      background: #ccc;
      z-index: 1;
    }

    .progress-line-filled {
      position: absolute;
      top: 15px;
      left: 15%;
      height: 4px;
      background: #28a745;
      z-index: 2;
      transition: width 0.4s ease-in-out;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      flex: 1;
      text-align: center;
    }

    .circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: bold;
      z-index: 2;
      position: relative;
    }

    .progress-step.active .circle {
      background: #007bff;
    }

    .progress-step.completed .circle {
      background: #28a745;
    }
  </style>
</head>

<body>
  <header class="header1">
    <img src="/static/ksdma2.jpg" alt="Government Logo" height="50"
      style="vertical-align: middle; border-radius: 100%; margin-right: 3%;"> Disaster Relief Portal
  </header>
  <header id="top-header">
    <div class="wrapper">
      <h1 class="logo">Sahaya<span>hastham</span></h1>
      <nav class="main-nav">
        <ul>
          <li><a href="./about.html"></i>Task</a></li>
          <li><a href="#">Profile</a></li>
          <li><a href="/home">Logout</a></li>
        </ul>
      </nav>

      <div class="menu-toggle">
        <div class="hamburger"></div>
      </div>

    </div>
  </header>

  <div class="container-volunteer">
    <h2>Volunteer Task Dashboard</h2>
    <div class="volunteer-info-volunteer">
      <p><strong>Name:</strong>{{name}}</p>
      <p><strong>Volunteer ID:</strong>{{userid}}</p>
      <p><strong>Role:</strong> Emergency Response Volunteer</p>
    </div>
    <div id="taskList-volunteer"></div>
  </div>

  <div class="footer1" style="width: 100%; margin: 0%;">&copy; 2025 Government of India - Disaster Relief Department
  </div>

  <!-- Modal -->
  <div class="modal fade" id="supplyModal" tabindex="-1" aria-labelledby="supplyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="supplyModalLabel">Supply Tracking System</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="container-supply">
            <h2>Supply Tracking System</h2>
            <div class="supply-details">
              <p><strong>Starting Address:</strong> <span id="modalStartAddress"></span></p>
              <p><strong>Time:</strong> <span id="modalStartTime"></span></p>
            </div>
            <div class="progress-graph" id="modalProgressGraph"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="updateModalStatus(currentTaskId)">Update Status</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    
    userId="{{userid}}";

    let tasks1 = [];

    

    async function renderTasks() {

        await fetch("/get-tasks/")
        .then(response => {if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();})
        .then(data =>{
            tasks1 = data.taskls/*.filter(task => task.volunteerId ==="{{userid}}")*/;
            // renderTasks();
        })
        .catch(error => {
        console.error("Error fetching tasks:", error);
        alert("Failed to fetch tasks. Please try again later.");
    });

      const taskList = document.getElementById("taskList-volunteer");
      taskList.innerHTML = "";

      tasks1.forEach(task => {
        let formattedTime = "";
        if (task.time) {
            const dateObj = new Date(task.time); // Convert to Date object
            formattedTime = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }); // Format HH:MM (24-hour)
        }
        const taskDiv = document.createElement("div");
        taskDiv.className = `task-volunteer ${task.type === "supply" ? "supply-task" : ""}`;
        taskDiv.innerHTML = `
      <p><strong>Task:</strong> ${task.desc}</p>
      ${task.type === "supply" ? `<p><strong>Address:</strong> ${task.address}</p>` : ""}
      ${task.type === "supply" ? `<p><strong>Time:</strong> ${formattedTime}</p>` : ""}
      <p><strong>Status:</strong> <span id="status-${task.taskId}">${task.status}</span></p>
      ${task.type === "onSite" && task.status==="Pending" ? `<button class="status-btn-volunteer" onclick="updateStatus('${task.taskId}')">Mark as Completed</button>` : ""}
    `;

        // if (task.type === "supply" && status !== "Completed") {
        //   taskDiv.addEventListener("click", () => {
        //     window.location.href ="/supplytrack";
        //   });
        // }

        if (task.type === "supply" && status !== "Delivered") {
          taskDiv.addEventListener("click", () => {
            currentTaskId = task.taskId;
            document.getElementById("modalStartAddress").textContent = task.address;
            document.getElementById("modalStartTime").textContent = formattedTime;
            renderModalProgressGraph(currentTaskId);
            const modal = new bootstrap.Modal(document.getElementById('supplyModal'));
            modal.show();
          });
        }

        taskList.appendChild(taskDiv);
      });
    }

    async function updateStatus(taskId) {
    // Update the status on the webpage
    // const statusElement = document.getElementById(`status-${taskId}`);
    // if (statusElement) {
    //     statusElement.textContent = "Completed";
    // }

    // Send a request to the backend to update the status
    const confirmAction = confirm("Do you want to mark this task as completed? Once done, this cannot be undone.");
  
    
      

    await fetch("/update-task-status/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ taskId: taskId }),  // Correctly pass the taskId
    })
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to update task status");
            }
            return response.json();
        })
        .then(data => {
            console.log("Task status updated successfully:", data);
            renderTasks();
        })
        .catch(error => {
            console.error("Error updating task status:", error);
            alert("Failed to update task status. Please try again later.");
            // Revert the status on the webpage if the update fails
            // if (statusElement) {
            //     statusElement.textContent = "Pending";
            // }
        });

       
    }

    

    const steps = ["Pending", "Went for Pickup", "Item Collected", "Delivered"];
    const taskProgress = {};

    // function renderModalProgressGraph(currentTaskId) {
    //   const currentStatus = getTaskProgress(currentTaskId);
    //   const currentIndex = steps.indexOf(currentStatus);
    //   const progressPercentage = (currentIndex / (steps.length - 1)) * 80;

    //   document.getElementById("modalProgressGraph").innerHTML = `
    //     <div class="progress-line-filled" style="width: calc(${progressPercentage}% - 15px);"></div>
    //     ${steps.map((step, index) => `
    //       <div class="progress-step ${index === currentIndex ? "active" : index < currentIndex ? "completed" : ""}">
    //         <div class="circle">${index + 1}</div>
    //         <p>${step}</p>
    //       </div>
    //     `).join("")}
    //   `;
    // }

    // function getTaskProgress(taskId) {
    //   return taskProgress[taskId] || "Pending";
    // }


    // function setTaskProgress(taskId, status) {
    //   taskProgress[taskId] = status;
    // }

//     function getTaskProgress(TaskId){
//     fetch("/get-supply-status/", {
//         method: "POST",
//         headers: {
//             "Content-Type": "application/json",
//         },
//         body: JSON.stringify({ TaskId:TaskId }),  // Correctly pass the taskId
//     })
//     .then(response => {
//             if (!response.ok) {
//                 throw new Error("Failed to get supply status");
//             }
//             return response.json();
//         })
//     .then(data => {
//             console.log("supply status fetched successfully:", data);
//             status=data.result;
//             return status;
//         })


//   }

function getTaskProgress(taskId) {
  return fetch("/get-task-progress/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ taskId: taskId }),
  })
    .then(response => response.json())
    .then(data => {
        console.log("Task progress data:", data);
      if (data.status) {
        console.log("Task progress data:", data);
        return data.status;
      } else {
        console.error("Error fetching task status:", data.error);
        return "Pending"; // Default status
      }
    })
    .catch(error => {
      console.error("Error:", error);
      return "Pending"; // Default in case of error
    });
}


async function setTaskProgress(taskId, status) {
  await fetch("/set-task-progress/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ taskId: taskId, status: status }),
  })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        console.log("Task updated:", data.message);
        // const statusElement = document.getElementById(`status-${taskId}`);
        // if (statusElement) {
        //     statusElement.textContent = status;
        // }
      } else {
        console.error("Error updating task:", data.error);
      }
    })
    .catch(error => {
      console.error("Error:", error);
    });
}





  async function renderModalProgressGraph(currentTaskId) {
  const currentStatus =await getTaskProgress(currentTaskId);
  const currentIndex = steps.indexOf(currentStatus);
  const progressPercentage = (currentIndex / (steps.length - 1)) * 80;

  document.getElementById("modalProgressGraph").innerHTML = `
    <div class="progress-line-filled" style="width: calc(${progressPercentage}% - 15px);"></div>
    ${steps.map((step, index) => `
      <div class="progress-step ${index === currentIndex ? "active" : index < currentIndex ? "completed" : ""}">
        <div class="circle">${index + 1}</div>
        <p>${step}</p>
      </div>
    `).join("")}
  `;
}


   async function updateModalStatus(currentTaskId) {
      const currentStatus =await getTaskProgress(currentTaskId);
      let currentIndex = steps.indexOf(currentStatus);

      if (currentIndex < steps.length - 1) {
        currentIndex++;
        await setTaskProgress(currentTaskId, steps[currentIndex]);

        await renderModalProgressGraph();
        await renderTasks();

        if (steps[currentIndex] === "Delivered") {
          await setTaskProgress(currentTaskId, "Delivered");
          alert("Task completed successfully!");
          const modal = bootstrap.Modal.getInstance(document.getElementById('supplyModal'));
          modal.hide();
          await renderTasks();
        } else {
          await setTaskProgress(currentTaskId, steps[currentIndex]);
          modal.hide();
        }
      }
    }

    // Add event listener to refresh tasks when modal is closed
    // document.getElementById('supplyModal').addEventListener('hidden.bs.modal', () => {
    //   renderTasks();
    // });

    renderTasks();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>